#!/bin/sh -eux
: ${K8S_SU_USER:=coopadmin}

TMP=$(mktemp -d)
cd $TMP

# Keyer
touch $TMP/keys
if [ ! -z  "$KEYS_URL" ]; then
  curl --silent -L "$KEYS_URL"  >> $TMP/keys 
else
  echo 'no KEYS_URL given'
fi
if [ ! -z  "$KEYS_TO_ADD" ]; then
  echo "$KEYS_TO_ADD" >>  $TMP/keys
else
  echo 'no KEYS_TO_ADD given'
fi
mkdir -p /root/.ssh
chmod 700 /root/.ssh
cp $TMP/keys /root/.ssh/authorized_keys
chmod 600 $TMP/keys /root/.ssh/authorized_keys

ls -lh /root/.ssh
#cat /root/.ssh/authorized_keys

useradd $K8S_SU_USER
groupadd -rf docker
gpasswd -a $K8S_SU_USER docker
groupadd -rf sudo
gpasswd -a $K8S_SU_USER sudo
mkdir -p /home/$K8S_SU_USER
chmod 777 $TMP
mkdir -p /home/coopadmin/.ssh
chmod 700 /home/coopadmin/.ssh
cp $TMP/keys /home/coopadmin/.ssh/authorized_keys
chmod 600 $TMP/keys /home/coopadmin/.ssh/authorized_keys
chown -R $K8S_SU_USER. /home/$K8S_SU_USER
chown -R $K8S_SU_USER. $TMP

rm -Rf $TMP
